<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTMX File Upload Example</title>
    <link rel="icon" type="image/svg+xml" href="/static/img/favicon.svg">
    <script src="https://unpkg.com/htmx.org@2.0.3"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <h1>File Upload Example</h1>
        <p>Demonstrates file upload with HTMX using real-time progress tracking based on <a href="https://htmx.org/examples/file-upload/" target="_blank">htmx.org/examples/file-upload</a></p>

        <!-- Single File Upload -->
        <div class="upload-section">
            <h2>Single File Upload</h2>

            <!-- hx-encoding: Required for file uploads (multipart/form-data) -->
            <!-- hx-post: Sends file to server via POST -->
            <!-- hx-target: Where to display the upload result -->
            <form id="upload-form"
                  hx-encoding="multipart/form-data"
                  hx-post="/upload"
                  hx-target="#upload-result">

                <input type="file" name="file"
                       accept=".png,.jpg,.jpeg,.gif,.webp,.svg,.pdf,.doc,.docx,.txt,.zip,.rar,.7z,.csv,.json,.xml">

                <button type="submit" class="btn">Upload</button>

                <!-- Progress bar updated via JavaScript listening to htmx:xhr:progress -->
                <progress id="progress" value="0" max="100"></progress>
            </form>

            <div id="upload-result"></div>
        </div>

        <!-- Multiple File Upload -->
        <div class="upload-section">
            <h2>Multiple File Upload</h2>

            <form id="multi-upload-form"
                  hx-encoding="multipart/form-data"
                  hx-post="/upload-multiple"
                  hx-target="#multi-upload-result">

                <input type="file" name="files" multiple
                       accept=".png,.jpg,.jpeg,.gif,.webp,.svg,.pdf,.doc,.docx,.txt,.zip,.rar,.7z,.csv,.json,.xml">

                <button type="submit" class="btn">Upload Files</button>

                <progress id="multi-progress" value="0" max="100"></progress>
            </form>

            <div id="multi-upload-result"></div>
        </div>

        <!-- Uploaded Files List -->
        <div class="preview-section">
            <h2>Uploaded Files</h2>

            <!-- hx-get: Load file list from server -->
            <!-- hx-trigger: Load on page load and when uploadComplete event fires -->
            <!-- hx-swap: Replace entire div contents -->
            <div id="file-list"
                 hx-get="/files"
                 hx-trigger="load, uploadComplete from:body"
                 hx-swap="innerHTML">
                Loading...
            </div>
        </div>

        <!-- Educational Information -->
        <div class="info">
            <h3>How it works:</h3>
            <ul>
                <li><code>hx-encoding="multipart/form-data"</code> - Proper encoding for file uploads</li>
                <li><code>hx-post="/upload"</code> - Send files to server endpoint</li>
                <li><code>htmx:xhr:progress</code> event - Real-time progress tracking</li>
                <li><code>&lt;progress&gt;</code> element - HTML5 progress bar for visual feedback</li>
            </ul>

            <h3>Security Features:</h3>
            <ul>
                <li><strong>Server-side validation</strong> - File type, size, and content checks</li>
                <li><strong>Secure filenames</strong> - Prevent path traversal attacks</li>
                <li><strong>Size limits</strong> - 16MB maximum file size</li>
                <li><strong>Type restrictions</strong> - Allowed file extensions only</li>
            </ul>
        </div>
    </div>

    <!-- Progress tracking using HTMX events -->
    <!-- NOTE: JavaScript is required here because HTMX alone cannot update progress bars.
         The htmx:xhr:progress event provides loaded/total bytes that must be calculated
         and applied to the progress element's value attribute. -->
    <script>
        // Single file upload progress tracking
        htmx.on('#upload-form', 'htmx:xhr:progress', function(evt) {
            htmx.find('#progress').setAttribute('value', evt.detail.loaded/evt.detail.total * 100);
        });

        // Multiple file upload progress tracking
        htmx.on('#multi-upload-form', 'htmx:xhr:progress', function(evt) {
            htmx.find('#multi-progress').setAttribute('value', evt.detail.loaded/evt.detail.total * 100);
        });

        // Reset progress bars after completion and trigger file list refresh
        htmx.on('#upload-form', 'htmx:afterRequest', function() {
            setTimeout(function() {
                htmx.find('#progress').setAttribute('value', '0');
            }, 1000);
            htmx.trigger('body', 'uploadComplete');
        });

        htmx.on('#multi-upload-form', 'htmx:afterRequest', function() {
            setTimeout(function() {
                htmx.find('#multi-progress').setAttribute('value', '0');
            }, 1000);
            htmx.trigger('body', 'uploadComplete');
        });
    </script>
</body>
</html>
